mkdir -p "${HOME}/.termux/SakiSP-NEXT/MCserver"
download_JAVA() {
	echo "è¯·é€‰æ‹©è¦å®‰è£…çš„javaç‰ˆæœ¬ï¼ˆæ”¯æŒå¤šé€‰ï¼Œç”¨ç©ºæ ¼åˆ†éš”ï¼‰:"
	options=("quit" $(apt list openjdk-*-jdk 2>/dev/null | awk -F'/' '{print $1}' | grep '^openjdk'))
	for i in ${!options[@]}; do
		echo "$i. ${options[$i]}"
	done
	# è¯»å–ç”¨æˆ·è¾“å…¥
	read -e -p "è¯·è¾“å…¥æ‚¨çš„é€‰æ‹©ï¼š" user_input
	# åˆå§‹åŒ–é€‰ä¸­çš„é€‰é¡¹æ•°ç»„
	selected=()
	# å¤„ç†ç”¨æˆ·è¾“å…¥çš„é€‰é¡¹
	for opt in $user_input; do
		if [[ " ${options[@]} " =~ " ${options[$opt]} " ]]; then
			selected+=(" ${options[$opt]}")
		else
			echo "æ— æ•ˆçš„é€‰é¡¹ï¼š$opt"
		fi
	done
	# è¾“å‡ºç”¨æˆ·é€‰æ‹©çš„é€‰é¡¹
	if [ "${opt}" = "0" ]; then
		exit
	fi
	echo "æ‚¨é€‰æ‹©äº†ï¼š${selected[*]}"
	$package_manager install ${selected[*]} -y
	log "é€‰æ‹©çš„Java:${selected[*]}"
}
install_MC_SERVER() {
	log "å‡†å¤‡å®‰è£…MC_SERVER"
	while true; do
		if [ $(tput cols) -lt 55 ]; then
			echo "åŒæŒ‡æåˆå±å¹•ç¼©å°å±å¹•"
			echo "å½“å‰åªæœ‰$(tput cols)åˆ—"
		else
			break
		fi
		sleep 1
	done

	download_fastmirror_net_api_v3=$(curl -s https://download.fastmirror.net/api/v3)

	case $1 in
	0)
		exit
		;;
	pure)
		log "é€‰æ‹©æ ¸å¿ƒç±»å‹:æ’ä»¶"
		tag=$(echo "${download_fastmirror_net_api_v3}" | jq '.data[].tag' | grep -n "pure" | cut -d: -f1)
		;;
	mod)
		log "é€‰æ‹©æ ¸å¿ƒç±»å‹:æ¨¡ç»„"
		tag=$(echo "${download_fastmirror_net_api_v3}" | jq -r '.data[].tag' | grep -n "mod" | cut -d: -f1)
		;;
	bedrock)
		log "é€‰æ‹©æ ¸å¿ƒç±»å‹:Bedrock"
		tag=$(echo "${download_fastmirror_net_api_v3}" | jq -r '.data[].name' | grep -n "NukkitX" | cut -d: -f1)
		;;
	vanilla)
		log "é€‰æ‹©æ ¸å¿ƒç±»å‹:åŸç‰ˆ"
		tag=$(echo "${download_fastmirror_net_api_v3}" | jq '.data[].tag' | grep -n "vanilla" | cut -d: -f1)
		;;
	esac

	Download_MC_SERVER_class_menu=($(
		for i in ${tag[@]}; do
			echo -e "$(echo "${download_fastmirror_net_api_v3}" | jq -r .data[$((${i} - 1))].name)"
		done
	))
	current_index=1
	Download_MC_SERVER_class_menu_list_names=""

	for item in "${Download_MC_SERVER_class_menu[@]}"; do
		Download_MC_SERVER_class_menu_list_names+=" ${current_index} ${item}"
		let current_index++
	done
	user_choice_Download_MC_SERVER_class_menu=$(whiptail --title "é€‰æ‹©" --menu "é€‰æ‹©åŠŸèƒ½" 15 70 8 0 è¿”å›ä¸Šçº§ ${Download_MC_SERVER_class_menu_list_names} 3>&1 1>&2 2>&3)
	# echo Paper
	#æ ¸å¿ƒ
	# æ ¸å¿ƒèœå•
	case $user_choice_Download_MC_SERVER_class_menu in
	0)
		echo -e "${RED}quit${RES}"
		exit
		;;
	*)
		if [ ! $? = 0 ]; then
			exit
		fi
		;;
	esac

	Sort_download_minecraft_version=$(($(echo $tag | awk -v n="$user_choice_Download_MC_SERVER_class_menu" '{print $n}') - 1))
	# echo $tag | awk -v n="$user_choice_Download_MC_SERVER_class_menu" '{print $n}'
	# echo "---------------------------------------"
	# echo "$tag     $user_choice_Download_MC_SERVER_class_menu"

	Download_MC_SERVER_versions_menu=$(echo "${download_fastmirror_net_api_v3}" | jq -r .data[${Sort_download_minecraft_version}].mc_versions[])
	# echo 1.18.2 1.16.5 1.12.2

	# ä½¿ç”¨trå’Œsortå‘½ä»¤è¿›è¡Œè½¬æ¢å’Œæ’åº
	Download_MC_SERVER_versions_menu=$(echo $Download_MC_SERVER_versions_menu | tr ' ' '\n' | sort -t. -k1,1n -k2,2n -k3,3n -k4,4n | tac)

	# æ‰“å°æ’åºåçš„ç‰ˆæœ¬å·åˆ—è¡¨
	# echo $Download_MC_SERVER_versions_menu

	Download_MC_SERVER_versions_menu=(${Download_MC_SERVER_versions_menu})
	current_index=1
	Download_MC_SERVER_versions_menu_list_names=""
	for item in "${Download_MC_SERVER_versions_menu[@]}"; do
		Download_MC_SERVER_versions_menu_list_names+=" ${current_index} ${item}"
		let current_index++
	done
	user_choice_Download_MC_SERVER_versions_menu_list_names=$(whiptail --title "é€‰æ‹©" --menu "é€‰æ‹©åŠŸèƒ½" 15 70 8 0 è¿”å›ä¸Šçº§ ${Download_MC_SERVER_versions_menu_list_names} 3>&1 1>&2 2>&3)
	case $user_choice_Download_MC_SERVER_versions_menu_list_names in
	0)
		echo -e "${RED}quit${RES}"
		exit
		;;
	*)
		if [ ! $? = 0 ]; then
			exit
		fi
		log "æ ¸å¿ƒ:${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}"
		log "ç‰ˆæœ¬:${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]}"
		;;
	esac

	Download_MC_SERVER_url_NO_with_and=$(curl -s "https://download.fastmirror.net/api/v3/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}/${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]}?offset=0&limit=1")
	Download_MC_SERVER_Get_core_version=$(echo $Download_MC_SERVER_url_NO_with_and | jq -r .data.builds[].core_version)
	Download_MC_SERVER_url_YES_with_and=https://download.fastmirror.net/download/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}/${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]}/${Download_MC_SERVER_Get_core_version}
	log "ç»„æˆçš„mcserveråœ°å€:$Download_MC_SERVER_url_YES_with_and"
	if [ ! -d ${HOME}/.termux/SakiSP-NEXT/MCserver/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]} ]; then
		mkdir -p ${HOME}/.termux/SakiSP-NEXT/MCserver/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}
	fi
	if [ ! -d ${HOME}/.termux/SakiSP-NEXT/MCserver/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}/${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]} ]; then
		mkdir -p ${HOME}/.termux/SakiSP-NEXT/MCserver/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}/${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]}
	fi
	if wget -q --show-progress $Download_MC_SERVER_url_YES_with_and -O ${HOME}/.termux/SakiSP-NEXT/MCserver/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}/${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]}/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}_${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]}_server.jar; then
		log "ä¸‹è½½æˆåŠŸ"
		source ${HOME}/SakiSP-NEXT/function/Start_Java_MC_SERVER "${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}" "${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]}" # ç‰ˆæœ¬
	else
		log "ä¸‹è½½å¤±è´¥"
		rmdir -p ${HOME}/.termux/SakiSP-NEXT/MCserver/${Download_MC_SERVER_class_menu[$((user_choice_Download_MC_SERVER_class_menu - 1))]}/${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]} "${Download_MC_SERVER_versions_menu[$((user_choice_Download_MC_SERVER_versions_menu_list_names - 1))]}"
	fi

}
start_MC_SERVER() {
	log "å‡†å¤‡å¯åŠ¨mcserver"
	if [ ! -f "$(command -v java)" ]; then
		echo -e "${RED}ç›®å‰å¹¶æ²¡æœ‰ä»»ä½•å®‰è£… java ${RES}"
		echo -e "æ²¡æœ‰å®‰è£…java"
		download_JAVA
	fi

	list_dir ${HOME}/.termux/SakiSP-NEXT/MCserver/
	case $user_choice in
	0)
		echo -e "${RED}quit${RES}"
		exit
		;;
	*)
		if [ ! $? = 0 ]; then
			exit
		fi
		start_MC_SERVER_class=${list_items[$((user_choice - 1))]}
		log "é€‰æ‹©æ ¸å¿ƒç±»å‹:${start_MC_SERVER_class}"
		#æ ¸å¿ƒ
		;;
	esac

	list_dir ${HOME}/.termux/SakiSP-NEXT/MCserver/${start_MC_SERVER_class}
	case $user_choice in
	0)
		echo -e "${RED}quit${RES}"
		exit
		;;
	*)
		if [ ! $? = 0 ]; then
			exit
		fi
		if [ ! -f ${HOME}/.termux/SakiSP-NEXT/MCserver/${start_MC_SERVER_class}/${list_items[$((user_choice - 1))]}/start.sh ]; then
			log "æœªå¯»æ‰¾åˆ°å¯åŠ¨è„šæœ¬å¯åŠ¨é…ç½®ç¨‹åº"
			source ${HOME}/SakiSP-NEXT/function/Start_Java_MC_SERVER ${start_MC_SERVER_class} ${list_items[$((user_choice - 1))]}
		fi
		log "å¯åŠ¨mcserver"
		bash ${HOME}/.termux/SakiSP-NEXT/MCserver/${start_MC_SERVER_class}/${list_items[$((user_choice - 1))]}/start.sh
		#æ ¸å¿ƒ
		;;
	esac
}

rm_MC_SERVER() {
	log "å‡†å¤‡åˆ é™¤mcserver"
	list_dir ${HOME}/.termux/SakiSP-NEXT/MCserver/
	case $user_choice in
	0)
		echo -e "${RED}quit${RES}"
		exit
		;;
	*)
		if [ ! $? = 0 ]; then
			exit
		fi
		rm_MC_SERVER_class=${list_items[$((user_choice - 1))]}
		;;
	esac
	list_dir ${HOME}/.termux/SakiSP-NEXT/MCserver/${rm_MC_SERVER_class}
	case $user_choice in
	0)
		echo -e "${RED}quit${RES}"
		exit
		;;
	*)
		if [ ! $? = 0 ]; then
			exit
		fi
		op_type=$((RANDOM % 3 + 1))
		case $op_type in
			1)
				num1=$((RANDOM % 100))
				num2=$((RANDOM % 100))
				op_symbol="+"
				correct_sum=$(($num1 + $num2))
				;;
			2)
				num1=$((RANDOM % 100 + 50))
				num2=$((RANDOM % 50))
				op_symbol="-"
				correct_sum=$(($num1 - $num2))
				;;
			3)
				num1=$((RANDOM % 20 + 1))
				num2=$((RANDOM % 10 + 1))
				op_symbol="Ã—"
				correct_sum=$(($num1 * $num2))
				;;
		esac
		log "num1=$num1 op=$op_symbol num2=$num2"
		read -e -p "ğŸ§® äººç±»éªŒè¯ï¼š${num1}${op_symbol}${num2}=?" user_sum
		log "user_sum=$user_sum"
		if [ $user_sum -eq $correct_sum ]; then
			echo -e "\e[92mâœ… éªŒè¯å®Œæˆï¼Œæ‚¨å·²è¯æ˜ä½ æ˜¯äººç±»ï¼Œç»§ç»­æ“ä½œ\e[0m"
			sleep 2
			rm -rfv "${HOME}/.termux/SakiSP-NEXT/MCserver/${rm_MC_SERVER_class}/${list_items[$((user_choice - 1))]}"
			log "åˆ é™¤å®Œæˆ"
		else
			echo -e "\e[91mâŒ é”™è¯¯ï¼ä½ è¾“å…¥çš„ç­”æ¡ˆä¸æ­£ç¡®ã€‚åˆ é™¤ç¨‹åºå°†ä¸æ‰§è¡Œã€‚\e[0m"
			sleep 2
			log "å–æ¶ˆå¤±è´¥"
		fi
		;;
	esac
}

Import_zip_MC_SERVER() {
	log "å‡†å¤‡å¯¼å…¥zipæ ¼å¼çš„mcserver"
	self_install zip 
	self_install unzip
	if [ ! -d ${HOME}/.termux/SakiSP-NEXT/MCserver/å¯¼å…¥çš„MCserver/ ]; then
		mkdir -p ${HOME}/.termux/SakiSP-NEXT/MCserver/å¯¼å…¥çš„MCserver/
	fi
	log "è¯·é€‰æ‹©è¦å¯¼å…¥çš„zipæ–‡ä»¶"
	zip_file=$(whiptail --title "é€‰æ‹©zipæ–‡ä»¶ä»¥å½“å‰ç³»ç»Ÿç›®å½•ä¸ºå‡†" --inputbox "è¯·è¾“å…¥zipæ–‡ä»¶è·¯å¾„è§£å‹åç›´æ¥ä¸ºæœåŠ¡å™¨æ ¹ç›®å½•çš„zip" 10 60 3>&1 1>&2 2>&3)
	log "é€‰æ‹©çš„zipæ–‡ä»¶:${zip_file}"		
	nowtime=$(date +%y-%m-%d-%H:%M:%S)
	if [ ! -d ${HOME}/.termux/SakiSP-NEXT/MCserver/å¯¼å…¥çš„MCserver/${nowtime}è§£å‹åç›®å½•/ ]; then
		mkdir -p ${HOME}/.termux/SakiSP-NEXT/MCserver/å¯¼å…¥çš„MCserver/${nowtime}è§£å‹åç›®å½•/
	fi
	unzip "${zip_file}" -d "${HOME}/.termux/SakiSP-NEXT/MCserver/å¯¼å…¥çš„MCserver/${nowtime}è§£å‹åç›®å½•/"
	if [ ! $? = 0 ]; then
	log "å¯¼å…¥å¤±è´¥"
		exit
	fi
	log "å¯¼å…¥å®Œæˆ"
} 
Export_zip_MC_SERVER() {
	mkdir -p ${HOME}/.termux/SakiSP-NEXT/back
	log "å‡†å¤‡å¯¼å‡ºzipæ ¼å¼çš„mcserver"
	if [ ! -f "$(command -v zip)" ]; then
		echo -e "${RED}ç›®å‰å¹¶æ²¡æœ‰ä»»ä½•å®‰è£… zip ${RES}"
		echo -e "æ²¡æœ‰å®‰è£…zip"
		self_install zip
	fi
	list_dir ${HOME}/.termux/SakiSP-NEXT/MCserver/
	case $user_choice in
	0)
		echo -e "${RED}quit${RES}"
		exit
		;;
	*)
		if [ ! $? = 0 ]; then
			exit
		fi
		export_MC_SERVER_class=${list_items[$((user_choice - 1))]}
		log "é€‰æ‹©æ ¸å¿ƒç±»å‹:${export_MC_SERVER_class}"
		if [ ! $? = 0 ]; then
			exit
		fi
		#æ ¸å¿ƒ
		;;
	esac

	list_dir ${HOME}/.termux/SakiSP-NEXT/MCserver/${export_MC_SERVER_class}
	case $user_choice in
	0)
		echo -e "${RED}quit${RES}"
		exit
		;;
	*)
		if [ ! $? = 0 ]; then
			exit
		fi
		export_MC_SERVER_class_bb=${list_items[$((user_choice - 1))]}
		log "é€‰æ‹©æœåŠ¡å™¨ç‰ˆæœ¬ç±»å‹:${export_MC_SERVER_class_bb}"
		#æ ¸å¿ƒ
		;;
	esac

	log "è¯·è¾“å…¥å¯¼å‡ºzipæ–‡ä»¶å"
	read -e -p "è¯·è¾“å…¥å¯¼å‡ºzipæ–‡ä»¶å:" export_zip_name
	if [ -z "${export_zip_name}" ]; then
		export_zip_name="${export_MC_SERVER_class_bb}_$(date +%Y%m%d_%H%M%S).zip"
	fi

	if [ ! -d ${HOME}/.termux/SakiSP-NEXT/MCserver/${export_MC_SERVER_class}/${export_MC_SERVER_class_bb} ]; then
		log "æœªæ‰¾åˆ°æœåŠ¡å™¨:${export_MC_SERVER_class_bb}"
		exit
	fi

	cd ${HOME}/.termux/SakiSP-NEXT/MCserver/${export_MC_SERVER_class}/${export_MC_SERVER_class_bb}
	if zip -r "${HOME}/.termux/SakiSP-NEXT/back/${export_zip_name}" .; then
		log "å¯¼å‡ºå®Œæˆ:${HOME}/.termux/SakiSP-NEXT/back/${export_zip_name}"
	else
		log "å¯¼å‡ºå¤±è´¥"
	fi

}
install_MC_SERVER_MENU_OLD() {
	install_MC_SERVER_MENU_OLD=$(
		whiptail --title "æœåŠ¡å™¨æ ¸å¿ƒç§ç±»é€‰æ‹©" --menu "æŒ‰è‡ªå·±éœ€æ±‚æ¥" 15 60 7 \
			"1" "çº¯å‡€æœåŠ¡ç«¯â€”â€”æ’ä»¶" \
			"2" "modæœåŠ¡ç«¯" \
			"3" "åŸºå²©ç‰ˆæœåŠ¡ç«¯" \
			'4' 'åŸç‰ˆæœåŠ¡ç«¯' \
			"0" "é€€å‡º" 3>&1 1>&2 2>&3
	)
	case $install_MC_SERVER_MENU_OLD in
	0)
		return
		;;
	1)
		log "å‡†å¤‡å®‰è£…çº¯å‡€æœåŠ¡ç«¯"
		install_MC_SERVER pure
		;;
	2)
		log "å‡†å¤‡å®‰è£…modæœåŠ¡ç«¯"
		install_MC_SERVER mod
		;;
	3)
		log "å‡†å¤‡å®‰è£…peæœåŠ¡ç«¯"
		install_MC_SERVER bedrock
		;;
	4)
		log "å‡†å¤‡å®‰è£…åŸç‰ˆæœåŠ¡ç«¯"
		install_MC_SERVER vanilla
		;;
	esac
}
startMCSManager() {
	log "å¯åŠ¨mcsmanager"
	if [ -d /opt/mcsmanager/ ]; then
		log "mcsmanagerå·²å®‰è£…"
		# mcsmanager
		if [ "${system_os_type}" = proot ]; then
			log "ç³»ç»Ÿä¸ºprootå®¹å™¨"
			rm -rf /run/screen/S-root
			start_mcsmanager
		else
			log "ç³»ç»Ÿä¸ºéprootå®¹å™¨"
			systemctl start mcsm-daemon.service
			systemctl start mcsm-web.service
		fi
	else
		log "mcsmanageræœªå®‰è£…"
		log "å®‰è£…mcsmanager"
		installMCSManager
	fi
}
stopMCSManager() {
	log "å¯åŠ¨mcsmanager"
	if [ -d /opt/mcsmanager/ ]; then
		log "mcsmanagerå·²å®‰è£…"
		# mcsmanager
		if [ "${system_os_type}" = proot ]; then
			log "ç³»ç»Ÿä¸ºprootå®¹å™¨"
			rm -rf /run/screen/S-root
			stop_mcsmanager
		else
			log "ç³»ç»Ÿä¸ºéprootå®¹å™¨"
			systemctl stop mcsm-web.service
			systemctl stop mcsm-daemon.service
		fi
	else
		log "mcsmanageræœªå®‰è£…"
		echo -e "${WARNING}æ²¡å®‰è£…ç‚¹åˆ°å¤©è’åœ°è€ä¹Ÿæ²¡ç”¨${RES}"
	fi
}
installMCSManager() {
		if [ "${system_os_type}" = proot ]; then
			log "ç³»ç»Ÿä¸ºprootå®¹å™¨"
			if bash <(curl -sL https://gitee.com/moze_sz/MCSMFP/raw/master/setup_cn.sh); then
				log "å®‰è£…æˆåŠŸ"
			else
				log "å®‰è£…å¤±è´¥"
			fi
		else
			log "ç³»ç»Ÿä¸ºéprootå®¹å™¨"
			if wget -qO- https://script.mcsmanager.com/setup_cn.sh | bash; then
				log "å®‰è£…æˆåŠŸ"
			else
				log "å®‰è£…å¤±è´¥"
			fi
		fi
}
# curl -s https://download.fastmirror.net/api/v3 | jq -r '.data[].tag' | grep -n "pure" | cut -d: -f1
# çº¯å‡€æœåŠ¡ç«¯
# curl -s https://download.fastmirror.net/api/v3 | jq -r '.data[].tag' | grep -n "mod" | cut -d: -f1
# modæœåŠ¡ç«¯
# curl -s https://download.fastmirror.net/api/v3 | jq -r '.data[].tag' | grep -n "bedrock" | cut -d: -f1
# peæœåŠ¡ç«¯
# curl -s https://download.fastmirror.net/api/v3 | jq -r '.data[].tag' | grep -n "vanilla" | cut -d: -f1
# åŸç‰ˆæœåŠ¡ç«¯
# pure_tag=(echo "${}" | jq '.data[].tag' | grep -n "pure" | cut -d: -f1))
# è¡Œæ•°
# curl -s https://download.fastmirror.net/api/v3 | jq .data.[$((${pure_tag[1]}-1))].name
# è¡Œæ•°å¯¹åº”åå­—
# for i in ${tag[@]} ; do
# 	curl -s https://download.fastmirror.net/api/v3 | jq .data.[$((${i}-1))].name
# done
